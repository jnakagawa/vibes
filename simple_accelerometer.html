<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Audio Control</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #222;
            color: white;
            text-align: center;
            padding: 20px;
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        button {
            padding: 20px;
            font-size: 20px;
            margin: 20px;
            border-radius: 10px;
            border: none;
            background: #007acc;
            color: white;
        }
        #character {
            font-size: 40vh;
            margin: 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: -1;
            opacity: 0.7;
        }
        .controls {
            position: relative;
            z-index: 10;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <h1>Audio Speed Control</h1>
        <button onclick="startAudio()">START</button>
        <button onclick="stopAudio()">STOP</button>
        <div>Speed: <span id="speed">1.0</span>x</div>
    </div>
    <div id="character">観</div>
    
    <script>
        let audioElement;
        let isPlaying = false;
        let speed = 1.0;
        let startTime = 0;
        
        const hanyaText = '觀自在菩薩行深般若波羅密多時照見五蘊皆空度一切苦厄舍利子色不異空空不異色色即是空空即是色受想行識亦復如是舍利子是諸法空相不生不滅不垢不淨不增不減是故空中無色無受想行識無眼耳鼻舌身意無色聲香味觸法無眼界乃至無意識界無無明亦無無明盡乃至無老死亦無老死盡無苦集滅道無智亦無得以無所得故菩提薩埵依般若波羅密多故心無罣礙無罣礙故無有恐怖遠離顛倒夢想究竟涅槃三世諸佛依般若波羅密多故得阿耨多羅三藐三菩提故知般若波羅密多是大神咒是大明咒是無上咒是無等等咒能除一切苦真實不虛故說般若波羅密多咒即說咒曰揭諦揭諦波羅揭諦波羅僧揭諦菩提薩婆訶摩訶般若波羅密多';
        
        function initAudio() {
            audioElement = new Audio('tools/vocal.mp3');
            audioElement.loop = true;
            audioElement.volume = 0.8;
            audioElement.addEventListener('loadeddata', () => {
                console.log('Audio loaded, duration:', audioElement.duration);
            });
        }
        
        function startAudio() {
            if (!audioElement) {
                initAudio();
                setTimeout(startAudio, 100);
                return;
            }
            
            audioElement.play().then(() => {
                isPlaying = true;
                startTime = Date.now();
                updateCharacters();
                console.log('Audio started');
            }).catch(e => {
                console.error('Play failed:', e);
            });
        }
        
        function stopAudio() {
            if (audioElement) {
                audioElement.pause();
                audioElement.currentTime = 0;
            }
            isPlaying = false;
        }
        
        function updateCharacters() {
            if (!isPlaying || !audioElement.duration) {
                requestAnimationFrame(updateCharacters);
                return;
            }
            
            // Calculate position based on audio currentTime and speed
            const audioProgress = (audioElement.currentTime % audioElement.duration) / audioElement.duration;
            const charIndex = Math.floor(audioProgress * hanyaText.length);
            document.getElementById('character').textContent = hanyaText[charIndex] || '観';
            
            if (isPlaying) {
                requestAnimationFrame(updateCharacters);
            }
        }
        
        // Initialize audio on page load
        initAudio();
        
        // Accelerometer control - much simpler
        if (window.DeviceMotionEvent) {
            window.addEventListener('devicemotion', (e) => {
                if (e.accelerationIncludingGravity && isPlaying) {
                    const z = e.accelerationIncludingGravity.z || 0;
                    
                    // Map Z to speed: face down = 0.25x, face up = 4x (browser limits)
                    let normalizedZ = (z + 10) / 20;
                    normalizedZ = Math.max(0, Math.min(1, normalizedZ));
                    normalizedZ = 1 - normalizedZ;
                    
                    // Use browser-safe range
                    const minSpeed = 0.25;
                    const maxSpeed = 4.0;
                    speed = minSpeed + (maxSpeed - minSpeed) * normalizedZ;
                    
                    // Apply to audio element
                    try {
                        audioElement.playbackRate = speed;
                        document.getElementById('speed').textContent = speed.toFixed(2);
                    } catch (e) {
                        console.log('Playback rate error:', e);
                    }
                }
            });
        }
    </script>
</body>
</html>