<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Clean Accelerometer Audio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .container {
            text-align: center;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        button {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 20px 40px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
        }

        #character {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 50vh;
            font-weight: bold;
            color: rgba(255,255,255,0.8);
            z-index: -1;
            pointer-events: none;
        }

        .info {
            margin: 20px 0;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Audio Speed Control</h1>
        <button onclick="startAudio()">START</button>
        <button onclick="stopAudio()">STOP</button>
        <div class="info">Speed: <span id="speed">1.0</span>x</div>
        <div class="info">Tilt phone: face down = slow, face up = fast</div>
    </div>
    
    <div id="character"></div>

    <script>
        let audioContext;
        let audioBuffer;
        let source;
        let gainNode;
        let isPlaying = false;
        let speed = 1.0;
        let actualStartTime = 0;
        let logicalPosition = 0;
        
        const hanyaText = '觀自在菩薩行深般若波羅密多時照見五蘊皆空度一切苦厄舍利子色不異空空不異色色即是空空即是色受想行識亦復如是舍利子是諸法空相不生不滅不垢不淨不增不減是故空中無色無受想行識無眼耳鼻舌身意無色聲香味觸法無眼界乃至無意識界無無明亦無無明盡乃至無老死亦無老死盡無苦集滅道無智亦無得以無所得故菩提薩埵依般若波羅密多故心無罣礙無罣礙故無有恐怖遠離顛倒夢想究竟涅槃三世諸佛依般若波羅密多故得阿耨多羅三藐三菩提故知般若波羅密多是大神咒是大明咒是無上咒是無等等咒能除一切苦真實不虛故說般若波羅密多咒即說咒曰揭諦揭諦波羅揭諦波羅僧揭諦菩提薩婆訶摩訶般若波羅密多';

        async function loadAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                gainNode = audioContext.createGain();
                gainNode.gain.value = 0.8;
                gainNode.connect(audioContext.destination);
                
                const response = await fetch('tools/vocal.mp3');
                const arrayBuffer = await response.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                console.log('Audio loaded successfully');
            } catch (error) {
                console.error('Failed to load audio:', error);
            }
        }

        async function startAudio() {
            if (!audioBuffer) {
                await loadAudio();
            }
            
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            // Stop any existing source
            if (source) {
                try {
                    source.stop();
                } catch (e) {}
            }

            // Create new source
            source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.loop = true;
            source.playbackRate.value = speed * 0.8; // 20% lower pitch
            source.connect(gainNode);
            source.start(0);

            actualStartTime = audioContext.currentTime;
            logicalPosition = 0;
            isPlaying = true;

            // Start update loop
            updateLoop();
        }

        function stopAudio() {
            if (source) {
                try {
                    source.stop();
                } catch (e) {}
                source = null;
            }
            isPlaying = false;
            document.getElementById('character').textContent = '';
        }

        function updateLoop() {
            if (!isPlaying || !audioBuffer) return;

            // Calculate logical position based on speed changes
            const elapsed = audioContext.currentTime - actualStartTime;
            logicalPosition = (logicalPosition + elapsed * speed) % audioBuffer.duration;
            actualStartTime = audioContext.currentTime;

            // Update character display
            const progress = logicalPosition / audioBuffer.duration;
            const charIndex = Math.floor(progress * hanyaText.length);
            document.getElementById('character').textContent = hanyaText[charIndex] || '';

            // Update speed display
            document.getElementById('speed').textContent = speed.toFixed(2);

            // Continue loop
            requestAnimationFrame(updateLoop);
        }

        function changeSpeed(newSpeed) {
            if (!source || !isPlaying) return;
            
            speed = newSpeed;
            
            // Update the actual audio playback rate
            source.playbackRate.setValueAtTime(speed * 0.8, audioContext.currentTime);
        }

        // Initialize
        loadAudio();

        // Accelerometer control
        if (window.DeviceMotionEvent) {
            window.addEventListener('devicemotion', (event) => {
                if (!event.accelerationIncludingGravity || !isPlaying) return;
                
                const z = event.accelerationIncludingGravity.z || 0;
                
                // Map Z axis: face down (+10) = 0.1x, face up (-10) = 100x
                let normalizedZ = (z + 10) / 20;
                normalizedZ = Math.max(0, Math.min(1, normalizedZ));
                normalizedZ = 1 - normalizedZ; // Invert
                
                // Exponential scale
                const minSpeed = 0.1;
                const maxSpeed = 100;
                const newSpeed = minSpeed * Math.pow(maxSpeed / minSpeed, normalizedZ);
                
                changeSpeed(newSpeed);
            });
        }
    </script>
</body>
</html>